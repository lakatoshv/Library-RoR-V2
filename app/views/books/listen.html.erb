<div id="loading" class="navbar-fixed-top"></div>
<div class="col-md-4 col-md-offset-4 back">
  <p id="notice"><%= notice %></p>
  <div class="show_h2 text-center">
    <ul class="list-group list-group-flush">
      <li class="list-group-item">
        <p class="show_h2 text-center">
          <strong>Прослухати <%= @book.title %></strong>
        </p>
      </li>
      <li class="list-group-item text-center">
        <p class="show_h2">
          <strong>Автор: <%= @book.auth %></strong>
        </p>
      </li>
      <li class="list-group-item">
        <center><%= image_tag @book.image_url.url(:medium), :class => "img-thumbnail" %></center>
      </li>
      <%
        text = []
        #contents = File.read("public/uploads/" + @book.name_of_file + "." + @book.rozshirennya)
        #text = contents.encode(Encoding.find('UTF-8'))
        #text = File.read("public/uploads/" + @book.name_of_file + "." + @book.rozshirennya)
        #text = ""

        reader = PDF::Reader.new("public/uploads/Origin.pdf")
        #book_page = 1
        reader.pages.each do |page| 
          if page.blank? != true || page.empty? != true
            text.push page.text
          end
        end
      %>
      <li class="list-group-item page">
        <center>Сторінка: 1</center>
      </li>
      <li class="list-group-item">
        <div class="form-group">
          <textarea class="form-control" id="textForSpeach"></textarea>
        </div>
      </li> 
      <li class="list-group-item">
        <div class="form-row align-items-center form-group">
          <label>
            <span>Голос: </span>
            <select class="custom-select mr-sm-2" id="voiceOptions"></select>
          </label>
        </div>
      </li>
      <li class="list-group-item">
        <div class="form-group">
          <label><span>Гучність: </span>
          <input class="form-control" type="range" id="volumeSlider" min="0" max="1" value="0.5" step="0.1">
        </div>
      </li>
      <li class="list-group-item">
        <div class="form-group">
          <label><span>Rate: </span>
          <input class="form-control" type="range" id="rateSlider" min="0" max="1" value="0.5" step="0.1">
        </div>
      </li>
      <li class="list-group-item">
        <div class="form-group">
          <label><span>Pitch: </span>
          <input class="form-control" type="range" id="pitchSlider" min="0" max="2" value="0.5" step="0.1">
        </div>
      </li>
      <li class="list-group-item">
        <center>
          <div class="btn-group" role="group">
            <div class="btn btn-default start"><span title="Play" id="play" class="glyphicon glyphicon-play aligned"></span> Розпочати</div>
            <div style="display: none;" class="btn btn-default pause"><span title="Play" id="play" class="glyphicon glyphicon-pause aligned"></span> Пауза</div>
            <div style="display: none;" class="btn btn-default resume"><span title="Play" id="play" class="glyphicon glyphicon-play aligned"></span> Продовжити</div>
            <div style="display: none;" class="btn btn-default stop"><span title="Play" id="play" class="glyphicon glyphicon-stop aligned"></span> Зупинити</div>
          </div>
        </center>
      </li>
      <li class="list-group-item">
        <div class="btn-group" role="group">
          <div class="btn btn-default" onclick="Prev()"><span title="-1 second" id="play" class="glyphicon glyphicon-chevron-left aligned"></span> Попередня сторінка</div>
          <div class="btn btn-default" onclick="Next()">Наступна сторінка <span title="+1 second" id="play" class="glyphicon glyphicon-chevron-right aligned"></span></div>
        </div>
      </li>
    </ul>
  </div> 
  <script type="text/javascript">
    //старт плеєра
    $(".start").click(function() {
      $(".start").html("<span title='Play' id='play' class='glyphicon glyphicon-play aligned'></span> Розпочати з початку");
      $(".pause").show();
      $(".stop").show();
      speak('speak');
      /*
        if($('input[name=type]:checked').val() == "upload"){
            $(".addurl").hide()
            $(".upload").show();
        }
        else if($('input[name=type]:checked').val() == "addurl"){
            $(".addurl").show();
            $(".upload").hide();
        }
      */
    });
    //пауза
    $(".pause").click(function() {
      $(".pause").hide();
      $(".resume").show();
      speak('pause');
    });
     //відновлення
    $(".resume").click(function() {
      $(".pause").show();
      $(".resume").hide();
      speak('continue');
    });
    //стоп
    $(".stop").click(function() {
      $(".pause").hide();
      $(".resume").hide();
      $(".stop").hide();
      $(".start").html("<span title='Play' id='play' class='glyphicon glyphicon-play aligned'></span> Розпочати");
      speak('stop');
    });

    var i = 0;
    var text = <%=  text.to_json.html_safe %>;
    $("#textForSpeach").text(text[i])
    function Next(){
      i++;
      $(".page center").text("Сторінка: " + (i+1))
      $("#textForSpeach").text(text[i])
    }
    function Prev(){
      i--;
      $(".page center").text("Сторінка: " + (i+1));
      $("#textForSpeach").text(text[i])
    }


    var voiceOptions = document.getElementById("voiceOptions");
    var volumeSlider = document.getElementById("volumeSlider");
    var rateSlider = document.getElementById("rateSlider");
    var pitchSlider = document.getElementById("pitchSlider");
    var textForSpeach = document.getElementById("textForSpeach");
    var voiceMap = [];

    function loadVoices(){
      var voices = speechSynthesis.getVoices();
      for(var i = 0; i < voices.length; i++){
        var voice = voices[i];
        var option = document.createElement("option");
        option.value = voice.name;
        option.innerHTML = voice.name + "(" + voice.lang + ")";
        voiceOptions.appendChild(option);
        voiceMap[voice.name] = voice;
      }
    }

    window.speechSynthesis.onvoiceschanged = function(e){
      loadVoices();
    }

    function speak(action){
      if(action === "stop"){
        speechSynthesisInstance.cancel();
      }
      else if(action === "speak"){
        speechSynthesis.cancel();
        var msg = new SpeechSynthesisUtterance(textForSpeach.value);
        msg.volume = volumeSlider.value;
        msg.voice = voiceMap[voiceOptions.value];
        msg.rate = rateSlider.value;
        msg.pitch = pitchSlider.value;
        speechSynthesis.speak(msg);
        /*
        msg.onend = function(event) {
          if(action !== "stop"){
            Next();
            speak("speak");
          }
        }
        */
      }
      else if(action === "pause"){
        speechSynthesis.pause();
      }
      else if(action === "continue"){
        speechSynthesis.resume();
      }
    }
  </script>
</div>
<script type="text/javascript">
  $(".back-top").hide();
    $(function () {
        $(window).scroll(function () {
            if ($(this).scrollTop() > 100) {
                $('.back-top').fadeIn();
            } else {
                $('.back-top').fadeOut();
            }
        });
        $('#back-top a').click(function () {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
    $(".return").click(function () {
      location = "../";
    });
</script>

<script type="text/javascript">
  /*
  const msg = new SpeechSynthesisUtterance();
  let voices = [];
  const voicesDropdown = document.querySelector('[name="voice"]');
  const options = document.querySelectorAll('[type="range"], [name="text"]');
  const speakButton = document.querySelector("#speak");
  const stopButton = document.querySelector("#stop");
  msg.text = document.querySelector("#textForSpeach").value;

  function populateVoices(){
    voices = speechSynthesis.getVoices();
    voicesDropdown.innerHTML = voices
      .map(voice => `
        <option value="${voice.name}">${voice.name} (${voice.lang})</option>`).join('');
  }
  function setVoice(){
    msg.voice = voices.find(voice => voice.name === this.value);
    toggle();
  }
  function toggle(startOver = true){
    speechSynthesis.cancel();
    if(startOver){
      speechSynthesis.speak(msg);
    }
  }

  window.speechSynthesis.addEventListener("onvoicechanged", populateVoices);
  voicesDropdown.addEventListener("change", setVoice);
  */
</script>